<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:models="clr-namespace:TrayFolder.Models"
                    xmlns:helpers="clr-namespace:TrayFolder.Helpers">

    <helpers:ImageSourceToImageConverter x:Key="ImageSourceToImageConverter"/>

    <HierarchicalDataTemplate x:Key="FileSystemItemTemplate" DataType="{x:Type models:FileSystemItem}" ItemsSource="{Binding Children}">
        <StackPanel Orientation="Horizontal">
            <!-- Icon is now handled by MenuItem.Icon via Style -->
            <TextBlock Text="{Binding Name}" Foreground="Black" VerticalAlignment="Center" />
        </StackPanel>
    </HierarchicalDataTemplate>

    <Style x:Key="FileSystemMenuItemStyle" TargetType="MenuItem">
        <!-- Header is set by ItemTemplate -->
        <Setter Property="ItemsSource" Value="{Binding Children}" />
        <Setter Property="Command" Value="{Binding OpenCommand}" />
        
        <!-- Bind Icon using Converter -->
        <Setter Property="Icon" Value="{Binding SysIcon, Converter={StaticResource ImageSourceToImageConverter}}" />
        
        <!-- Bind IsSubmenuOpen to IsExpanded to trigger lazy loading -->
        <Setter Property="IsSubmenuOpen" Value="{Binding IsExpanded, Mode=TwoWay}" />
        
        <!-- Recursion: Apply the same style to children -->
        <Setter Property="ItemContainerStyle" Value="{DynamicResource FileSystemMenuItemStyle}" />
        
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="MenuItem">
                    <Border x:Name="templateRoot" 
                            BorderBrush="{TemplateBinding BorderBrush}" 
                            BorderThickness="{TemplateBinding BorderThickness}" 
                            Background="{TemplateBinding Background}" 
                            SnapsToDevicePixels="True">
                        <Grid Margin="3">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="20"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="20"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Icon -->
                            <ContentPresenter x:Name="Icon" 
                                              Content="{TemplateBinding Icon}" 
                                              ContentSource="Icon" 
                                              HorizontalAlignment="Center" 
                                              VerticalAlignment="Center" 
                                              Width="16" Height="16" 
                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                            
                            <!-- Header -->
                            <ContentPresenter x:Name="menuHeaderContainer" 
                                              Grid.Column="2" 
                                              ContentTemplate="{TemplateBinding HeaderTemplate}" 
                                              Content="{TemplateBinding Header}" 
                                              ContentStringFormat="{TemplateBinding HeaderStringFormat}" 
                                              ContentSource="Header" 
                                              HorizontalAlignment="Left" 
                                              VerticalAlignment="Center" 
                                              Margin="8,0,0,0"
                                              RecognizesAccessKey="True" 
                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                            
                            <!-- Arrow (for submenus) -->
                            <Path x:Name="RightArrow" Grid.Column="4" Data="M0,0 L4,3.5 L0,7 Z" Fill="Black" HorizontalAlignment="Center" VerticalAlignment="Center" Visibility="Collapsed"/>
                            
                            <!-- Popup for Submenu -->
                            <Popup x:Name="PART_Popup" 
                                   AllowsTransparency="True" 
                                   Focusable="False" 
                                   HorizontalOffset="0" 
                                   IsOpen="{Binding IsSubmenuOpen, RelativeSource={RelativeSource TemplatedParent}}" 
                                   PopupAnimation="Fade" 
                                   Placement="Right" 
                                   VerticalOffset="-3">
                                <Border x:Name="SubMenuBorder" 
                                        BorderBrush="#FF999999" 
                                        BorderThickness="1" 
                                        Background="White" 
                                        Padding="2">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsPresenter x:Name="ItemsPresenter" 
                                                        KeyboardNavigation.DirectionalNavigation="Cycle" 
                                                        Grid.IsSharedSizeScope="True" 
                                                        SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" 
                                                        KeyboardNavigation.TabNavigation="Cycle"/>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                    </Border>
                    
                    <ControlTemplate.Triggers>
                        <!-- Highlight Trigger -->
                        <Trigger Property="IsHighlighted" Value="True">
                            <Setter Property="Background" TargetName="templateRoot" Value="#E5F3FF"/>
                            <Setter Property="BorderBrush" TargetName="templateRoot" Value="#CCE8FF"/>
                            <Setter Property="BorderThickness" TargetName="templateRoot" Value="1"/>
                        </Trigger>
                        
                        <!-- Show Arrow if has items -->
                        <Trigger Property="HasItems" Value="True">
                            <Setter Property="Visibility" TargetName="RightArrow" Value="Visible"/>
                        </Trigger>
                        
                        <!-- Disable if needed -->
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="Opacity" TargetName="templateRoot" Value="0.5"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <!-- Hide empty submenus for files -->
        <Style.Triggers>
            <DataTrigger Binding="{Binding IsFolder}" Value="False">
                <Setter Property="ItemsSource" Value="{x:Null}" />
            </DataTrigger>
        </Style.Triggers>
    </Style>

    <Style x:Key="ModernContextMenuStyle" TargetType="ContextMenu">
        <Setter Property="SnapsToDevicePixels" Value="True" />
        <Setter Property="OverridesDefaultStyle" Value="True" />
        <Setter Property="Grid.IsSharedSizeScope" Value="True" />
        <Setter Property="HasDropShadow" Value="True" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="ContextMenu">
                    <Border Name="Border" Background="White" BorderBrush="#FF999999" BorderThickness="1" Padding="2">
                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="HasDropShadow" Value="true">
                            <Setter TargetName="Border" Property="Padding" Value="2" />
                            <Setter TargetName="Border" Property="CornerRadius" Value="0" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>
